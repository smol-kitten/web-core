ARG BASE_IMAGE=prep_base:24.04
FROM ${BASE_IMAGE}

# Install apache2 and runtime dependencies for PHP extensions
# Dynamically detect package names for different Ubuntu versions (t64 transition in 25.10)
RUN apt-get update && \
        apt-get install -y \
            apache2 \
            $(apt-cache search --names-only '^libxml2(-[0-9]+)?$' | awk '{print $1}' | head -1) \
            libsqlite3-0 \
            $(apt-cache search --names-only '^libssl3(t64)?$' | awk '{print $1}' | head -1) \
            $(apt-cache search --names-only '^libcurl4(t64)?$' | awk '{print $1}' | head -1) \
            libonig5 \
            $(apt-cache search --names-only '^libreadline8(t64)?$' | awk '{print $1}' | head -1) \
            libbz2-1.0 \
            $(apt-cache search ^libzip[45]$ | awk '{print $1}' | head -1) \
            $(apt-cache search --names-only '^libpng16-16(t64)?$' | awk '{print $1}' | head -1) \
            libjpeg8 \
            libfreetype6 \
            libwebp7 \
            libxpm4 \
            zlib1g \
            libsodium23 \
            libargon2-1

# Enable Apache modules for PHP-FPM
RUN a2enmod proxy_fcgi setenvif rewrite

# Create PHP-FPM configuration for Apache
RUN echo "<FilesMatch \\.php$>\n\
    SetHandler \"proxy:unix:/var/run/php/php8.4-fpm.sock|fcgi://localhost\"\n\
</FilesMatch>" > /etc/apache2/conf-available/php8.4-fpm.conf && \
    a2enconf php8.4-fpm

# Create necessary directories
RUN mkdir -p /var/www/html

# Copy apache config
RUN mkdir -p /etc/apache2/sites-enabled; 
COPY src/apache/000-default.conf /etc/apache2/sites-enabled/000-default.conf

# Copy test index.php
COPY src/index.php /var/www/html/index.php
RUN rm /var/www/html/index.html
# Start apache and PHP-FPM
COPY src/docker-entrypoint-apache.sh /docker-entrypoint.sh
RUN chmod +x /docker-entrypoint.sh

CMD ["/docker-entrypoint.sh"]
