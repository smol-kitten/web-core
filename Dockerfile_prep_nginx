ARG BASE_IMAGE=prep_base:24.04
FROM ${BASE_IMAGE}

# Install nginx and runtime dependencies for PHP extensions
# Dynamically detect package names for different Ubuntu versions (t64 transition in 25.10)
RUN apt-get update && \
        apt-get install -y \
            nginx \
            $(apt-cache search --names-only '^libxml2(-[0-9]+)?$' | awk '{print $1}' | head -1) \
            libsqlite3-0 \
            $(apt-cache search --names-only '^libssl3(t64)?$' | awk '{print $1}' | head -1) \
            $(apt-cache search --names-only '^libcurl4(t64)?$' | awk '{print $1}' | head -1) \
            libonig5 \
            $(apt-cache search --names-only '^libreadline8(t64)?$' | awk '{print $1}' | head -1) \
            libbz2-1.0 \
            $(apt-cache search ^libzip[45]$ | awk '{print $1}' | head -1) \
            $(apt-cache search --names-only '^libpng16-16(t64)?$' | awk '{print $1}' | head -1) \
            libjpeg8 \
            libfreetype6 \
            libwebp7 \
            libxpm4 \
            zlib1g \
            libsodium23 \
            libargon2-1

# Create necessary directories
RUN mkdir -p /var/www/html /run/nginx

# Copy nginx config (with conditional paths for Alpine vs Ubuntu)
RUN mkdir -p /etc/nginx/sites-enabled; 
COPY src/nginx/nginx.conf /etc/nginx/nginx.conf
COPY src/nginx/site.conf /etc/nginx/sites-enabled/nginx.conf

# Copy test index.php
COPY src/index.php /var/www/html/index.php
RUN rm /var/www/html/index.nginx-debian.html
# Start nginx and php-fpm
COPY src/docker-entrypoint-nginx.sh /docker-entrypoint.sh
RUN chmod +x /docker-entrypoint.sh

CMD ["/docker-entrypoint.sh"]