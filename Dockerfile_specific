ARG BASE_IMAGE=prep_nginx:24.04
FROM ${BASE_IMAGE}

# NOTE: Imagick is now installed in prep_nginx_imagick and prep_apache2_imagick
# If INSTALL_IMAGICK=true, the workflow uses those prep images as BASE_IMAGE
# This avoids 10+ minute PECL compilation for every variant

# Build args for optional extensions
ARG INSTALL_IMAGICK=true
ARG INSTALL_SQLITE=false
ARG INSTALL_MYSQL=false
ARG INSTALL_SSH2=false

# Note: phpdbg is not yet available in OndÅ™ej's PPA for PHP 8.4
# It has been removed from the build matrix

# Add Debian sid repository for additional PHP packages (like php8.4-sqlite3)
# Import GPG keys first to avoid verification errors
RUN apt-get update && \
    apt-get install -y --no-install-recommends gnupg && \
    apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 6ED0E7B82643E131 78DBA3BC47EF2265 && \
    echo "deb http://ftp.de.debian.org/debian sid main" >> /etc/apt/sources.list && apt-get update
    

RUN if [ "$INSTALL_SQLITE" = "true" ]; then \
        apt-get install -y php8.4-sqlite3; \
    fi

RUN if [ "$INSTALL_MYSQL" = "true" ]; then \
        apt-get install -y php8.4-mysql; \
    fi

RUN if [ "$INSTALL_SSH2" = "true" ]; then \
        apt-get install -y php8.4-ssh2; \
    fi

RUN apt-get purge -y gnupg && apt-get autoremove -y && apt-get clean && rm -rf /var/lib/apt/lists/*
