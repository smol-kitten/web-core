ARG BASE_IMAGE=prep_nginx:24.04
FROM ${BASE_IMAGE}

# NOTE: Imagick is now installed in prep_nginx_imagick and prep_apache2_imagick
# If INSTALL_IMAGICK=true, the workflow uses those prep images as BASE_IMAGE
# This avoids 10+ minute PECL compilation for every variant

# Build args for optional extensions
# Note: SQLite, MySQL/MySQLi/PDO MySQL are already built into PHP from source
ARG INSTALL_IMAGICK=true
ARG INSTALL_SSH2=false
ARG INSTALL_REDIS=false
ARG INSTALL_MEMCACHED=false
ARG INSTALL_CRON=false

# Install optional extensions via PECL
# SSH2 - SSH protocol support
RUN if [ "$INSTALL_SSH2" = "true" ]; then \
        apt-get update && \
        apt-get install -y libssh2-1-dev && \
        pecl install ssh2-1.4.1 && \
        echo "extension=ssh2.so" > /usr/local/php8.4/etc/conf.d/20-ssh2.ini; \
    fi

# Redis - In-memory data structure store client
RUN if [ "$INSTALL_REDIS" = "true" ]; then \
        pecl install redis && \
        echo "extension=redis.so" > /usr/local/php8.4/etc/conf.d/20-redis.ini; \
    fi

# Memcached - Distributed memory caching system client
RUN if [ "$INSTALL_MEMCACHED" = "true" ]; then \
        apt-get update && \
        apt-get install -y libmemcached-dev zlib1g-dev && \
        pecl install memcached && \
        echo "extension=memcached.so" > /usr/local/php8.4/etc/conf.d/20-memcached.ini; \
    fi

# Cron - Task scheduler for running periodic jobs
RUN if [ "$INSTALL_CRON" = "true" ]; then \
        apt-get update && \
        apt-get install -y cron; \
    fi

# Install and protect runtime libraries explicitly before cleanup
# These are dependencies of dev packages that will be removed
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        libgd3 \
        $(apt-cache search --names-only '^libicu[0-9]+$' | awk '{print $1}' | head -1) \
        $([ "$INSTALL_SSH2" = "true" ] && echo "libssh2-1" || echo "") \
        $([ "$INSTALL_MEMCACHED" = "true" ] && echo "libmemcached11" || echo "") && \
    apt-mark manual libgd3 2>/dev/null && \
    apt-mark manual $(apt-cache search --names-only '^libicu[0-9]+$' | awk '{print $1}' | head -1) 2>/dev/null && \
    ([ "$INSTALL_SSH2" = "true" ] && apt-mark manual libssh2-1 2>/dev/null || true) && \
    ([ "$INSTALL_MEMCACHED" = "true" ] && apt-mark manual libmemcached11 2>/dev/null || true) && \
    rm -rf /var/lib/apt/lists/*

# Cleanup: Remove build tools and dev packages to reduce image size
RUN apt-get purge -y \
        build-essential \
        autoconf \
        bison \
        re2c \
        pkg-config \
        libxml2-dev \
        libsqlite3-dev \
        libssl-dev \
        libcurl4-openssl-dev \
        libonig-dev \
        libreadline-dev \
        libbz2-dev \
        libzip-dev \
        libpng-dev \
        libjpeg-dev \
        libfreetype6-dev \
        libwebp-dev \
        libxpm-dev \
        zlib1g-dev \
        libsodium-dev \
        libargon2-dev \
        libgd-dev \
        libicu-dev \
        libmagickwand-dev \
        libssh2-1-dev \
        libmemcached-dev \
        wget 2>/dev/null || true && \
    apt-get autoremove -y && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* \
           /usr/src/php-8.4.1 \
           /tmp/* \
           /var/tmp/*
